---
title: "Comparing forest recovery trajectories following wildfire in the presence and absence of spruce budworm defoliation using remotely sensed data"
author: 
  name: 
  - "Jack A. Goldman^1^,"
  - "Marie-Josée Fortin^2^," 
  - "Patrick M.A. James^1^" 
  affiliations: 
  - ^1^Institute of Forestry and Conservation, University of Toronto
  - ^2^Department of Ecology and Evolutionary Biology, University of toronto
format: 
  revealjs:
    multiplex: true
    footer: "jackagoldman.github.io"
    theme: ["custom.scss"]
    slide-number: c/t
    incremental: true
    title-slide-attributes:
      data-background-image: content/qc-95-map-basic.png
      data-background-size: 30%
      data-background-position: left
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r setup}
#| include: false

knitr::opts_knit$set(root.dir = '~/git/presentations/iale-2024')

library(nlme)
library(ggplot2)
library(tidyverse)
df <- read.csv("data/on-qc-full-dataset_v1.csv")

df <- df |> 
  dplyr::group_by(fire_name) |> 
  dplyr::mutate(id_nest =cur_group_id()) 

# for interactive plots
library(DiagrammeR)
library(tmap)
library(sf)
library(gt)
library(emmeans)
library(lme4)
library(optimx)
library(lmerTest)
#library(patchwork)
#library(shadowtext)

# for color
#ibrary(paletteer)

#\

# for fonts
#library(showtext)
#font_add_google("Jost", "Jost")
#showtext_auto()
#theme_set(theme_minimal(base_family = "Jost"))


```

## Background
:::: {.columns}

::: {.column width="60%"}
-   Wildfire and SBW defoliationmost widespread disturbances in the eastern boreal forest
- SBW Affected over 9.6 mha of Eastern boreal forest in since 2006

-   Boreal forests are adapted to both stand-replacing wildfire and spruce budworm defoliation

-   independently, each disturbance facilitates the regeneration of boreal forest stands


-   However due to CC. the spatial legacies of defoliated areas are being increasingly burned, with consequences for wildfire behaviour and implications for wildfire recovery

:::

::: {.column width="40%"}
{{< video content/patrick_embed_video_NOSOUND.mp4 width="500" height="350" >}}

:::

::::

## Wildfire behaviour and post-fire recovery

:::: {.columns}

::: {.column width="60%"}

- SBW legacies alter connectivity and amount of flammable fuels
- Potentially altering wildfire behaviour (i.e., burn severity)
- Wildfire behaviour directly influence post-fire recovery by..
- Shifts in the wildfire behavior due to SBW legacies may lead to divergent post-fire recovery trajectories.

:::

::: {.column width="40%"}
![](content/fb-triangle.png)

:::

::::


## Current understanding of SBW x Wildfire behaviour is unclear

-  SBW defoliation has been shown to increase wildfire behaviour (Flemind and Candau 2002; Jame et al. 2017)
- In the west, Western SBW has been shown to decrease wildfire behaviour
- Various other studies report no effect
-   window of opportunity
-   why? 
- one potential reason for the lack of consistency in the findings is that wildfires are noisy, and we are trying to detect a small signal (specific change in fuel), in a large and noisy system.
-   big data problem?
- we decided to approach this problem different and try to reduce the uncertainty and remove noise 

## Research Question

How do the spatial legacies of spruce budworm defoliation influence wildfire burn severity and forest recovery in the boreal forest?

- Is there a difference in forest recovery between 1-5 years and 6-10 years post-fire between defoliated and non-defoliated fires?

```{python}
#| include: false


import pandas as pd
import geopandas as gd
import pygmt
import matplotlib.pyplot as plt

defol = gd.read_file("/Users/jgoldman/Desktop/OneDrive - University of Toronto/Data/chapter_3/on-qc-defol.shp")
non_defol = gd.read_file("/Users/jgoldman/Desktop/OneDrive - University of Toronto/Data/chapter_3/on-qc-nondefol.shp")

#get centroids
defol["x"] = defol.centroid.x
defol["y"] = defol.centroid.y

non_defol["x"] = non_defol.centroid.x
non_defol["y"] = non_defol.centroid.y

# merge dfs
studyDF = pd.concat([defol, non_defol])

# rename XY to lat and long
studyDF = studyDF.rename(columns ={'x': 'longitude', 'y': 'latitude'})

# Set the region for the plot to be slightly larger than the data bounds.
region = [
    studyDF.longitude.min() - 5,
    studyDF.longitude.max() + 5,
    studyDF.latitude.min() - 5,
    studyDF.latitude.max() + 5,
]



fig = pygmt.Figure()
fig.basemap(region=region, projection="M15c", frame=True)
fig.coast( land="lightgreen", 
    water="lightblue",
    shorelines=True,
    dcw=[
        # Ontario with black line
        "CA.ON+p1p,black",
        "CA.QC+p1p,black"
    ],
)

pygmt.makecpt(cmap="plasma", series=[studyDF.Fire_Year.min(), studyDF.Fire_Year.max()])
fig.plot(x=studyDF.longitude, y=studyDF.latitude, style="t0.18c", color= studyDF.Fire_Year, cmap=True)
fig.colorbar( 
             position = "jBL+o1c/2c+w7c/+w4c/0.5c+h",
             box ="+gwhite+p1p",
             frame=["af", "x+lFire Year"],
             )

#Create an inset map, setting the position to bottom right, and the x- and
# y-offsets to 0.1 cm, respectively.
# The inset map contains the Japan main land. "U54S/3c" means UTM projection
# with a map width of 3 cm. The inset width and height are automatically
# calculated from the specified ``region`` and ``projection`` parameters.
# Draws a rectangular box around the inset with a fill color of "white" and
# a pen of "1p".
with fig.inset(
    region="CA",
    position="jTR+o0.1c",
    box="+gwhite+p1p",
    projection="M3c",
    
):
    # Highlight the Japan area in "lightbrown"
    # and draw its outline with a pen of "0.2p". #CA.ON+gred #"CA+glightbrown+p1p"
    fig.coast(land="gray",
        borders=[1, 2],
        shorelines="1/thin",
        water="white",
        dcw=["CA.ON+gred","CA.QC+gred"],
        area_thresh=10000,
    )
    # Plot a rectangle ("r") in the inset map to show the area of the main
    # figure. "+s" means that the first two columns are the longitude and
    # latitude of the bottom left corner of the rectangle, and the last two
    # columns the longitude and latitude of the uppper right corner.
    #rectangle = [[region[0], region[2], region[1], region[3]]]
    #fig.plot(data=rectangle, style="r+s", pen="2p,blue")
pygmt.set_display(method="external") 
fig.show()

```

![studyarea](content/study-area-v1.png)

## Experimental approach
:::: {.columns}

::: {.column width="60%"}
-   matched pairs design
-   why did we do this? control for noise
-   

:::

::: {.column width="40%"}
![Example of fire where half with defoliated and non-defoliated areas](content/qc-95-map-basic.png)
 
:::

::::


::: {.notes}
One of the difficulties in modelling the effect of SBW is quantifying the severity of sbw defoliation.
Two key characteristics of SBW defoliation have been identified in the literature:
Time since defoliation and cumulative defoliation
Studies normally model these and individual predictors or in separate models.
It is possible that the lack of evidence for SBW-Fire interactions is due to models ability to capture defoliation severity.
I proposed a novel method to quantifying defoliation severity using latent composite variables in SEMs
Latent composite variables are used to represent a property (in this case defoliation severity) that arise from the collective influence of certain predictors. 
The error terms indicate that we do not include all the possible predictors because the condition of defoliation severity may also include unobservables. 
:::

## Hypothesized causal network

```{r dev.args = list(bg = 'transparent')}
DiagrammeR::grViz("content/chapter3-dag.gv")
```

::: {.notes}
We used piecewise structural equation models too explore the causal pathways between forest structure, snow melt and remotely-sensed burn severity. We fit our pSEM using linear mixed effects models controlling for size class and fire year. We know about these relationships but we don’t know we don’t know the weights, therefore this approach allows us to compare the weights of the causal pathways. (standardized regression coefficients)

When studying complex interactions, it is difficult to isolate the individual effects of different pathways. However new developments in structural equation modelling allow us to tease apart the relative contributions of a single driver when the mediation effects of others are taken into effect. 
SEM allow us to examine causal relationships among variables, while simultaneously accounting for measurement error and condition effects based on other covariates.

:::

## Data


::: {.notes}
We gathered remotely sensed snow cover and burn severity using Google Earth Engine (GEE). 
We initially gathered wildfire severity maps for each fire that burned in our study area based on the wildfire database for Ontario (77). 
Burn severity was measured using the relativized burn ratio (RBR), a Landsat-based fire severity metric that represents the change in forest cover following a fire relative to the amount of pre-fire vegetative cover rather than the absolute change. 
RBR maps were calculated using mean composited multispectral imagery from Landsat-TM, -ETM and -OLI, following the hybrid method developed for the boreal forest region by Holsinger, Parks (35) that uses MODIS imagery to determine start and end date of fires. 

:::

## Median Severity Increases with Time Since Defoliation

```{r}

df<- df |> dplyr::mutate(window_op = case_when(tsd <= 3 ~ "0-3",
                               tsd >= 4 & tsd <=6 ~ "4-6",
                               tsd >= 7 & tsd <= 9 ~"7-9",
                              tsd >= 10 & tsd <= 12 ~"10-12",
                              tsd >= 13 & tsd <= 15 ~"13-15"))
###
med <- ggplot(df, aes(x = window_op, y = rbr_median, fill = prov)) +
  geom_boxplot() + 
  scale_x_discrete(labels = c('0-3','4-6','7-9', '10-12', '13-15')) +
  xlab("Time Since Defoliation") +
  ylab("Median Burn Severity") + 
  ggtitle("Differences in Median Burn Severity based on Time Since Defoliation")+
  guides(fill = guide_legend(title = "Province")) + 
  theme_bw()


med

```



## Preliminary Results

```{r}
#| message: false
#| warning: false
#| include: false


library(piecewiseSEM)


# create compositre
comp_model <- lm(rbr_median ~ tsd + cumltve_yrs, data = df)

beta_td <- summary(comp_model)$coefficients[2, 1]

beta_years <- summary(comp_model)$coefficients[3, 1]

df$composite <- beta_td * df$tsd + beta_years * df$cumltve_yrs

df$s_isi <- scale(df$spsm_isi)
df$s_bui <- scale(df$spsm_bui)
df$s_temp <- scale(df$post_fire_temp)
df$s_precip<- scale(df$post_fire_precip)




# model first 5 years
sem1 <- psem(

lmer(rbr_median~ s_isi + s_bui + tsd:cumltve_yrs + (0+id_nest|prov) + (1|fire_year) , data = df, 
        REML = FALSE,
        control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='L-BFGS-B'))),

  lmer(slope1 ~ rbr_median + s_temp + s_precip+ (0+id_nest|prov) + (1|fire_year), data = df,
       REML = FALSE,
        control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))


)

summary(sem1)

graph <- plot(sem1, return = TRUE)



graph$nodes_df[[4,3]] <- 'BUI'
graph$nodes_df[[3,3]] <- 'ISI'
graph$nodes_df[[2,3]] <- '1-5 Slope'
graph$nodes_df[[5,3]] <- 'tsd x cyd'
graph$nodes_df[[6,3]] <- 'mean\ntemperature'
graph$nodes_df[[7,3]] <- 'total\nprecipitation'
graph$nodes_df[[1,3]] <- 'Median Severity'

#global attributes, use to change labels
graph <- graph |>  add_global_graph_attrs(
  attr = "bgcolor",
  value = "#fcfbf9",
  attr_type = "graph")


gsem1 <- graph |> 
   set_node_attrs(
    node_attr = color,
    values = "black", 
    nodes = c(3,4,5,6,7)) |>
  set_node_attrs(
    node_attr = color,
    values = "red", 
    nodes = c(1,2)) |>
  set_node_attrs(node_attr = "fixedsize",
                 values = FALSE) |> 
  set_edge_attrs(edge_attr = color,
                 values = "grey") |> 
    set_edge_attrs(edge_attr = dir,
                 values = "forward") |> 
  render_graph(layout = "tree")





# model second 5 years

sem2 <- psem(

lmer(rbr_median~ s_isi + s_bui + tsd:cumltve_yrs + (0+id_nest|prov) + (1|fire_year) , data = df, 
        REML = FALSE,
        control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='L-BFGS-B'))),

  lmer(slope2 ~ rbr_median + s_temp + s_precip+ (0+id_nest|prov) + (1|fire_year), data = df,
       REML = FALSE,
        control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))


)

summary(sem2)

graph2 <- plot(sem2, return = TRUE)


graph2$nodes_df[[4,3]] <- 'BUI'
graph2$nodes_df[[3,3]] <- 'ISI'
graph2$nodes_df[[2,3]] <- '6-10 Slope'
graph2$nodes_df[[5,3]] <- 'tsd x cyd'
graph2$nodes_df[[6,3]] <- 'mean\ntemperature'
graph2$nodes_df[[7,3]] <- 'total\nprecipitation'
graph2$nodes_df[[1,3]] <- 'Median Severity'

#global attributes, use to change labels
graph2 <- graph2 |>  add_global_graph_attrs(
  attr = "bgcolor",
  value = "#fcfbf9",
  attr_type = "graph")


gsem2 <- graph2|> 
   set_node_attrs(
    node_attr = color,
    values = "black", 
    nodes = c(3,4,5,6,7)) |>
  set_node_attrs(
    node_attr = color,
    values = "red", 
    nodes = c(1,2)) |>
  set_node_attrs(node_attr = "fixedsize",
                 values = FALSE) |> 
  set_edge_attrs(edge_attr = color,
                 values = "grey") |> 
    set_edge_attrs(edge_attr = dir,
                 values = "forward") |> 
  render_graph(layout = "tree")




```


::: {layout-ncol=2}

```{r, dev = "png", dev.args=list(bg="transparent")}
gsem1
```

```{r, dev = "png", dev.args=list(bg="transparent")}
gsem2
```


:::

## Takeaways

1. Median burn severity had a significant impact on recovery for the first 5 years following fire but not for the second 5 years. 
2. Mean temperature and total precipitation had a positive effect on the second half of recovery but a negative effect on the first. 
3. Defoliation indirectly effects slope of recovery for the first 5 years post fire through increases in median burn severity.


## acknowledgments
:::: {.columns}

::: {.column width="40%"}

- Patrick MA James
- Marie-Josée Fortin
- Mike Wotton
- James Caspersen
- Bill Shipley
- James Lab
- Fortin Lab


:::

::: {.column width="60%"}

![James Lab](content/IMG_8698.jpg)
:::

::::




## distribution of tsd


```{r}
ggplot(df[df$defoliated == 1,], aes(tsd, fill = prov)) + 
  geom_histogram(binwidth = 1, colour = "black", linetype = "dashed") +
  theme_bw() + ggtitle("Frequency of Time Since Defoliation") + xlab("Time Since Defoliation") +
  guides(fill = guide_legend(title = "Province"))
```